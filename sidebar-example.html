<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JJConnect - 示例页面</title>
  
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    /* Custom styles */
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    /* Custom scrollbar */
    .overflow-y-auto::-webkit-scrollbar {
      width: 6px;
    }
    
    .overflow-y-auto::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .overflow-y-auto::-webkit-scrollbar-thumb {
      background: #cbd5e0;
      border-radius: 3px;
    }
    
    .overflow-y-auto::-webkit-scrollbar-thumb:hover {
      background: #a0aec0;
    }
  </style>
</head>
<body class="bg-gray-50">

  <!-- Main Content Area (with right padding for sidebar) -->
  <main class="min-h-screen pr-20 md:pr-64 lg:pr-80 transition-all duration-300 p-8">
    
    <div class="max-w-4xl mx-auto">
      <h1 class="text-4xl font-bold text-gray-900 mb-4">欢迎来到 JJConnect</h1>
      <p class="text-lg text-gray-600 mb-8">
        这是一个示例页面，展示了右侧边栏的集成效果。
      </p>
      
      <!-- Your page content goes here -->
      <div class="bg-white rounded-lg shadow-sm p-6">
        <h2 class="text-2xl font-semibold mb-4">页面内容</h2>
        <p class="text-gray-600 mb-4">
          右侧边栏会自动加载分类、精选内容，并根据用户登录状态显示相应的功能入口。
        </p>
        <ul class="list-disc list-inside space-y-2 text-gray-600">
          <li>搜索功能</li>
          <li>官方分类导航</li>
          <li>授权用户快捷入口（需要登录且 is_authorized = true）</li>
          <li>精选付费内容列表</li>
          <li>响应式设计（移动端自适应）</li>
        </ul>
      </div>
    </div>

  </main>

  <!-- Right Sidebar -->
  <aside id="right-sidebar" class="fixed right-0 top-0 h-screen w-20 md:w-64 lg:w-80 bg-white border-l border-gray-200 overflow-y-auto z-40 transition-all duration-300">
    <div class="p-4 space-y-6">
      
      <!-- Search Section -->
      <section class="space-y-2">
        <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wide hidden md:block">
          搜索
        </h3>
        <form action="/search" method="GET" class="relative">
          <input
            type="search"
            name="q"
            placeholder="搜索..."
            class="w-full px-3 py-2 pl-10 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent hidden md:block"
          />
          <button
            type="submit"
            class="md:absolute md:left-3 md:top-1/2 md:-translate-y-1/2 w-12 h-12 md:w-auto md:h-auto mx-auto flex items-center justify-center md:inline-flex text-gray-400 hover:text-gray-600 bg-gray-100 md:bg-transparent rounded-full md:rounded-none"
            aria-label="搜索"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
          </button>
        </form>
      </section>

      <!-- Categories Section -->
      <section class="space-y-2" id="categories-section">
        <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wide hidden md:block">
          官方分类
        </h3>
        <nav class="space-y-1" id="categories-list">
          <!-- Categories will be loaded here -->
          <div class="text-center py-4">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto"></div>
          </div>
        </nav>
      </section>

      <!-- User Shortcuts (shown if authorized) -->
      <section class="space-y-2 hidden" id="user-shortcuts">
        <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wide hidden md:block">
          快捷入口
        </h3>
        <nav class="space-y-1">
          <a href="/dashboard" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-blue-50 text-gray-700 hover:text-blue-600 transition-colors" title="管理我的记录">
            <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <span class="text-sm font-medium hidden md:block">管理我的记录</span>
          </a>
          <a href="/posts/new" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-green-50 text-gray-700 hover:text-green-600 transition-colors" title="发布文章">
            <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            <span class="text-sm font-medium hidden md:block">发布文章</span>
          </a>
          <a href="/profile/settings" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50 text-gray-700 hover:text-gray-900 transition-colors" title="个人设置">
            <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            <span class="text-sm font-medium hidden md:block">个人设置</span>
          </a>
        </nav>
      </section>

      <!-- Featured Content -->
      <section class="space-y-2" id="featured-section">
        <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wide hidden md:block">
          精选专栏
        </h3>
        <div class="space-y-2" id="featured-list">
          <!-- Featured posts will be loaded here -->
          <div class="text-center py-4">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto"></div>
          </div>
        </div>
      </section>

      <!-- Login Prompt -->
      <section class="space-y-2" id="login-prompt">
        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-4 hidden md:block">
          <h4 class="text-sm font-semibold text-gray-900 mb-2">加入我们</h4>
          <p class="text-xs text-gray-600 mb-3">登录后即可发布内容、关注作者、参与讨论</p>
          <a href="/login.html" class="block w-full text-center bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-2 px-4 rounded-lg transition-colors">
            立即登录
          </a>
        </div>
        <a href="/login.html" class="flex items-center justify-center md:hidden w-12 h-12 mx-auto bg-blue-600 hover:bg-blue-700 text-white rounded-full transition-colors" title="登录">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
        </a>
      </section>

    </div>
  </aside>

  <!-- Right Sidebar JavaScript -->
  <script>
    // Replace with your Supabase credentials
    const SUPABASE_URL = 'YOUR_SUPABASE_URL';
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
    
    // Initialize Supabase
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Load categories
    async function loadCategories() {
      try {
        const { data, error } = await supabase
          .from('categories')
          .select('*')
          .order('name', { ascending: true });
        
        if (error) throw error;
        
        const categoriesList = document.getElementById('categories-list');
        if (data && data.length > 0) {
          categoriesList.innerHTML = data.map(category => `
            <a
              href="/category/${category.slug}"
              class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 text-gray-700 hover:text-gray-900 transition-colors group"
              title="${category.description || category.name}"
            >
              <span class="w-2 h-2 rounded-full bg-blue-500 flex-shrink-0"></span>
              <span class="text-sm font-medium truncate hidden md:block">
                ${category.name}
              </span>
            </a>
          `).join('');
        } else {
          document.getElementById('categories-section').classList.add('hidden');
        }
      } catch (error) {
        console.error('Failed to load categories:', error);
        document.getElementById('categories-section').classList.add('hidden');
      }
    }

    // Load featured posts
    async function loadFeaturedPosts() {
      try {
        const { data, error } = await supabase
          .from('posts')
          .select(`
            id,
            title,
            price,
            cover_image,
            author:profiles(display_name, avatar_url)
          `)
          .eq('status', 'published')
          .eq('is_paid', true)
          .order('created_at', { ascending: false })
          .limit(5);
        
        if (error) throw error;
        
        const featuredList = document.getElementById('featured-list');
        if (data && data.length > 0) {
          featuredList.innerHTML = data.map(post => `
            <a
              href="/posts/${post.id}"
              class="block group hover:bg-gray-50 rounded-lg p-2 transition-colors hidden md:block"
            >
              ${post.cover_image ? `
                <div class="aspect-video w-full mb-2 rounded overflow-hidden bg-gray-200">
                  <img
                    src="${post.cover_image}"
                    alt="${post.title}"
                    class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                  />
                </div>
              ` : ''}
              <h4 class="text-sm font-medium text-gray-900 line-clamp-2 mb-1 group-hover:text-blue-600 transition-colors">
                ${post.title}
              </h4>
              <div class="flex items-center justify-between text-xs">
                <span class="text-gray-600">
                  ${post.author?.display_name || '匿名'}
                </span>
                <span class="font-semibold text-orange-600">
                  ¥${post.price}
                </span>
              </div>
            </a>
          `).join('');
        } else {
          document.getElementById('featured-section').classList.add('hidden');
        }
      } catch (error) {
        console.error('Failed to load featured posts:', error);
        document.getElementById('featured-section').classList.add('hidden');
      }
    }

    // Check user authentication
    async function checkAuth() {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        
        const loginPrompt = document.getElementById('login-prompt');
        const userShortcuts = document.getElementById('user-shortcuts');
        
        if (user) {
          loginPrompt.classList.add('hidden');
          
          // Check if user is authorized
          const { data: profile } = await supabase
            .from('profiles')
            .select('is_authorized')
            .eq('id', user.id)
            .single();
          
          if (profile?.is_authorized) {
            userShortcuts.classList.remove('hidden');
          }
        } else {
          loginPrompt.classList.remove('hidden');
          userShortcuts.classList.add('hidden');
        }
      } catch (error) {
        console.error('Failed to check auth:', error);
      }
    }

    // Initialize sidebar
    async function initSidebar() {
      await Promise.all([
        loadCategories(),
        loadFeaturedPosts(),
        checkAuth()
      ]);
      
      // Listen for auth changes
      supabase.auth.onAuthStateChange((event, session) => {
        if (event === 'SIGNED_IN' || event === 'SIGNED_OUT') {
          checkAuth();
        }
      });
    }

    // Run on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initSidebar);
    } else {
      initSidebar();
    }
  </script>

</body>
</html>
