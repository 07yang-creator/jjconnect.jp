<!-- 
  Right Sidebar Integration Snippet
  Copy this into your existing HTML files (index.html, login.html, etc.)
-->

<!-- 1. Add these in <head> section -->
<head>
  <!-- ... your existing head content ... -->
  
  <!-- Tailwind CSS (if not already included) -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    /* Custom scrollbar for sidebar */
    .sidebar-scroll::-webkit-scrollbar { width: 6px; }
    .sidebar-scroll::-webkit-scrollbar-track { background: transparent; }
    .sidebar-scroll::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 3px; }
    .sidebar-scroll::-webkit-scrollbar-thumb:hover { background: #a0aec0; }
    
    /* Line clamp utility */
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</head>

<!-- 2. Update <body> tag to add right padding -->
<body class="pr-20 md:pr-64 lg:pr-80 transition-all duration-300">

  <!-- Your existing content stays here -->
  <main>
    <!-- ... -->
  </main>

  <!-- 3. Add Right Sidebar before closing </body> -->
  <aside id="right-sidebar" class="fixed right-0 top-0 h-screen w-20 md:w-64 lg:w-80 bg-white border-l border-gray-200 overflow-y-auto z-40 transition-all duration-300 sidebar-scroll">
    <div class="p-4 space-y-6">
      
      <!-- Search -->
      <section class="space-y-2">
        <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wide hidden md:block">搜索</h3>
        <form action="/search" method="GET" class="relative">
          <input type="search" name="q" placeholder="搜索..." class="w-full px-3 py-2 pl-10 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent hidden md:block" />
          <button type="submit" class="md:absolute md:left-3 md:top-1/2 md:-translate-y-1/2 w-12 h-12 md:w-auto md:h-auto mx-auto flex items-center justify-center md:inline-flex text-gray-400 hover:text-gray-600 bg-gray-100 md:bg-transparent rounded-full md:rounded-none" aria-label="搜索">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
          </button>
        </form>
      </section>

      <!-- Categories -->
      <section class="space-y-2" id="categories-section">
        <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wide hidden md:block">官方分类</h3>
        <nav class="space-y-1" id="categories-list">
          <div class="text-center py-4"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto"></div></div>
        </nav>
      </section>

      <!-- User Shortcuts -->
      <section class="space-y-2 hidden" id="user-shortcuts">
        <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wide hidden md:block">快捷入口</h3>
        <nav class="space-y-1">
          <a href="/dashboard" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-blue-50 text-gray-700 hover:text-blue-600 transition-colors" title="管理我的记录">
            <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
            <span class="text-sm font-medium hidden md:block">管理我的记录</span>
          </a>
          <a href="/posts/new" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-green-50 text-gray-700 hover:text-green-600 transition-colors" title="发布文章">
            <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
            <span class="text-sm font-medium hidden md:block">发布文章</span>
          </a>
        </nav>
      </section>

      <!-- Featured Content -->
      <section class="space-y-2" id="featured-section">
        <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wide hidden md:block">精选专栏</h3>
        <div class="space-y-2" id="featured-list">
          <div class="text-center py-4"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto"></div></div>
        </div>
      </section>

      <!-- Login Prompt -->
      <section class="space-y-2" id="login-prompt">
        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-4 hidden md:block">
          <h4 class="text-sm font-semibold text-gray-900 mb-2">加入我们</h4>
          <p class="text-xs text-gray-600 mb-3">登录后即可发布内容、关注作者、参与讨论</p>
          <a href="/login.html" class="block w-full text-center bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-2 px-4 rounded-lg transition-colors">立即登录</a>
        </div>
        <a href="/login.html" class="flex items-center justify-center md:hidden w-12 h-12 mx-auto bg-blue-600 hover:bg-blue-700 text-white rounded-full transition-colors" title="登录">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
        </a>
      </section>

    </div>
  </aside>

  <!-- 4. Add JavaScript before closing </body> -->
  <script>
    // ⚠️ IMPORTANT: Replace with your actual Supabase credentials
    const SUPABASE_URL = 'https://your-project.supabase.co';
    const SUPABASE_ANON_KEY = 'your-anon-key-here';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Load categories
    async function loadCategories() {
      try {
        const { data, error } = await supabase.from('categories').select('*').order('name', { ascending: true });
        if (error) throw error;
        
        const list = document.getElementById('categories-list');
        if (data?.length) {
          list.innerHTML = data.map(c => `
            <a href="/category/${c.slug}" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 text-gray-700 hover:text-gray-900 transition-colors" title="${c.description || c.name}">
              <span class="w-2 h-2 rounded-full bg-blue-500 flex-shrink-0"></span>
              <span class="text-sm font-medium truncate hidden md:block">${c.name}</span>
            </a>
          `).join('');
        } else {
          document.getElementById('categories-section').classList.add('hidden');
        }
      } catch (e) {
        console.error('Load categories error:', e);
        document.getElementById('categories-section').classList.add('hidden');
      }
    }

    // Load featured posts
    async function loadFeaturedPosts() {
      try {
        const { data, error } = await supabase.from('posts')
          .select('id, title, price, cover_image, author:profiles(display_name)')
          .eq('status', 'published').eq('is_paid', true)
          .order('created_at', { ascending: false }).limit(5);
        
        if (error) throw error;
        
        const list = document.getElementById('featured-list');
        if (data?.length) {
          list.innerHTML = data.map(p => `
            <a href="/posts/${p.id}" class="block group hover:bg-gray-50 rounded-lg p-2 transition-colors hidden md:block">
              ${p.cover_image ? `<div class="aspect-video w-full mb-2 rounded overflow-hidden bg-gray-200"><img src="${p.cover_image}" alt="${p.title}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300" /></div>` : ''}
              <h4 class="text-sm font-medium text-gray-900 line-clamp-2 mb-1 group-hover:text-blue-600 transition-colors">${p.title}</h4>
              <div class="flex items-center justify-between text-xs">
                <span class="text-gray-600">${p.author?.display_name || '匿名'}</span>
                <span class="font-semibold text-orange-600">¥${p.price}</span>
              </div>
            </a>
          `).join('');
        } else {
          document.getElementById('featured-section').classList.add('hidden');
        }
      } catch (e) {
        console.error('Load featured error:', e);
        document.getElementById('featured-section').classList.add('hidden');
      }
    }

    // Check auth
    async function checkAuth() {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        const loginPrompt = document.getElementById('login-prompt');
        const userShortcuts = document.getElementById('user-shortcuts');
        
        if (user) {
          loginPrompt.classList.add('hidden');
          const { data: profile } = await supabase.from('profiles').select('is_authorized').eq('id', user.id).single();
          if (profile?.is_authorized) userShortcuts.classList.remove('hidden');
        } else {
          loginPrompt.classList.remove('hidden');
          userShortcuts.classList.add('hidden');
        }
      } catch (e) {
        console.error('Auth check error:', e);
      }
    }

    // Initialize
    (async () => {
      await Promise.all([loadCategories(), loadFeaturedPosts(), checkAuth()]);
      supabase.auth.onAuthStateChange((event) => {
        if (event === 'SIGNED_IN' || event === 'SIGNED_OUT') checkAuth();
      });
    })();
  </script>

</body>
